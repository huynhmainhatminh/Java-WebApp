<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{admin/fragments/_header :: common_header(${user.id == null ? 'Thêm Người Dùng Mới' : 'Chỉnh Sửa Người Dùng'})}"></head>
<body class="hold-transition sidebar-mini layout-fixed">
<div class="wrapper">
  <nav th:replace="~{admin/fragments/_header :: navbar}"></nav>
  <aside th:replace="~{admin/fragments/_header :: sidebar('users')}"></aside>
  <div class="content-wrapper">
    <section class="content-header">
      <div class="container-fluid">
        <div class="row mb-2">
          <div class="col-sm-6">
            <h1 th:text="${user.id == null ? 'Thêm Người Dùng Mới' : 'Chỉnh Sửa Người Dùng'}"></h1>
          </div>
          <div class="col-sm-6">
            <ol class="breadcrumb float-sm-right">
              <li class="breadcrumb-item"><a th:href="@{/admin/dashboard}">Home</a></li>
              <li class="breadcrumb-item"><a th:href="@{/admin/users}">Quản lý Users</a></li>
              <li class="breadcrumb-item active" th:text="${user.id == null ? 'Thêm Mới' : 'Chỉnh Sửa'}"></li>
            </ol>
          </div>
        </div>
      </div>
    </section>
    <section class="content">
      <div class="container-fluid">
        <div class="card card-primary">
          <div class="card-header">
            <h3 class="card-title">Thông tin người dùng</h3>
          </div>
          <form th:action="${user.id == null} ? @{/admin/users} : @{/admin/users/update/{id}(id=${user.id})}" th:object="${user}" method="post">
            <input type="hidden" th:field="*{id}" />

            <div class="card-body">
              <div class="form-group">
                <label for="username">Tên tài khoản</label>
                <input type="text" class="form-control" id="username" th:field="*{username}" required>
              </div>
              <div class="form-group">
                <label for="fullName">Họ và Tên</label>
                <input type="text" class="form-control" id="fullName" th:field="*{fullName}" required>
              </div>
              <div class="form-group">
                <label for="email">Email</label>
                <input type="email" class="form-control" id="email" th:field="*{email}" required>
              </div>
              <div class="form-group" th:if="${user.id == null}">
                <label for="password">Mật khẩu</label>
                <input type="password" class="form-control" id="password" th:field="*{password}" required>
              </div>
              <div class="form-group">
                <label for="phoneNumber">Số điện thoại</label>
                <input type="tel" class="form-control" id="phoneNumber" th:field="*{phoneNumber}">
              </div>
              <div class="form-group">
                <label for="role">Vai trò</label>
                <select class="form-control" id="role" th:field="*{role}">
                  <option value="DRIVER">Driver</option>
                  <option value="STAFF">Staff</option>
                  <option value="ADMIN">Admin</option>
                </select>
              </div>

              <div class="form-group" id="station-group">
                <label for="station">Trạm (Chỉ dành cho STAFF)</label>
                <select class="form-control" id="station" th:field="*{station}">
                  <option value="">-- Không gán trạm --</option>
                  <option th:each="st : ${allStations}"
                          th:value="${st.id}"
                          th:text="${st.name}">
                  </option>
                </select>
                <small class="form-text text-muted">Chỉ gán trạm cho người dùng có vai trò là STAFF.</small>
              </div>
            </div>
            <div class="card-footer">
              <button type="submit" class="btn btn-primary">Lưu</button>
              <a th:href="@{/admin/users}" class="btn btn-secondary">Hủy</a>
            </div>
          </form>
        </div>
      </div>
    </section>
  </div>
  <footer th:replace="~{admin/fragments/_footer :: footer}"></footer>
</div>
<div th:replace="~{admin/fragments/_footer :: common_scripts}"></div>

<script>
  $(document).ready(function() {
    var roleSelect = $('#role');
    var stationGroup = $('#station-group');

    function toggleStationField() {
      if (roleSelect.val() === 'STAFF') {
        stationGroup.slideDown();
      } else {
        stationGroup.slideUp();
        // Tự động chọn "Không gán trạm" nếu không phải STAFF
        $('#station').val('');
      }
    }

    // Chạy lần đầu khi tải trang
    toggleStationField();

    // Chạy khi thay đổi Role
    roleSelect.on('change', function() {
      toggleStationField();
    });
  });
</script>

</body>
</html>