<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{admin/fragments/_header :: common_header(${transaction.id == null ? 'Tạo Giao Dịch Mới' : 'Chỉnh Sửa Giao Dịch'})}"></head>
<body class="hold-transition sidebar-mini layout-fixed">
<div class="wrapper">
    <nav th:replace="~{admin/fragments/_header :: navbar}"></nav>
    <aside th:replace="~{admin/fragments/_header :: sidebar('transactions')}"></aside>
    <div class="content-wrapper">
        <section class="content-header">
            <div class="container-fluid">
                <div class="row mb-2">
                    <div class="col-sm-6">
                        <h1 th:text="${transaction.id == null ? 'Tạo Giao Dịch Mới' : 'Chỉnh Sửa Giao Dịch'}"></h1>
                    </div>
                </div>
            </div>
        </section>
        <section class="content">
            <div class="container-fluid">
                <div class="card card-primary">
                    <div class="card-header"><h3 class="card-title">Thông tin giao dịch</h3></div>
                    <form th:action="${transaction.id == null} ? @{/admin/transactions} : @{/admin/transactions/update/{id}(id=${transaction.id})}" th:object="${transaction}" method="post">
                        <input type="hidden" th:field="*{id}" />
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="station">Trạm Giao Dịch</label>
                                        <select class="form-control" id="station" th:field="*{station}" required>
                                            <option value="">-- Chọn trạm --</option>
                                            <option th:each="st : ${stations}" th:value="${st.id}" th:text="${st.name}"></option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="user">Khách hàng</label>
                                        <select class="form-control" id="user" th:field="*{user}" required>
                                            <option value="">-- Chọn khách hàng --</option>
                                            <option th:each="u : ${users}" th:value="${u.id}" th:text="${u.username} + ' (' + ${u.fullName} + ')'"></option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="batteryIn">Pin Cũ (Pin trả vào - RENTED)</label>
                                        <select class="form-control" id="batteryIn" th:field="*{batteryIn}" required>
                                            <option value="">-- Chọn pin khách trả --</option>
                                            <option th:each="bat : ${rentedBatteries}"
                                                    th:value="${bat.id}"
                                                    th:text="${bat.serialNumber} + ' (' + ${bat.currentChargePercentage} + '%)'"
                                                    th:data-user-id="${bat.currentUser?.id}"> </option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="batteryOut">Pin Mới (Pin lấy ra - AVAILABLE)</label>
                                        <select class="form-control" id="batteryOut" th:field="*{batteryOut}" required>
                                            <option value="">-- Vui lòng chọn trạm trước --</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6"><div class="form-group"><label>Số tiền</label><input type="number" step="1000" class="form-control" th:field="*{amount}" required></div></div>
                                <div class="col-md-6"><div class="form-group"><label>Trạng thái TT</label><select class="form-control" th:field="*{paymentStatus}"><option value="PENDING">Chờ xử lý</option><option value="COMPLETED">Hoàn thành</option></select></div></div>
                            </div>
                            <div class="row">
                                <div class="col-md-6"><div class="form-group"><label>Phương thức TT</label><select class="form-control" th:field="*{paymentMethod}" required><option value="CASH">Tiền mặt</option><option value="WALLET">Ví điện tử</option></select></div></div>
                                <div class="col-md-6"><div class="form-group"><label>Ghi chú</label><textarea class="form-control" rows="1" th:field="*{notes}"></textarea></div></div>
                            </div>
                        </div>
                        <div class="card-footer">
                            <button type="submit" class="btn btn-primary">Lưu Giao Dịch</button>
                            <a th:href="@{/admin/transactions}" class="btn btn-secondary">Hủy</a>
                        </div>
                    </form>
                </div>
            </div>
        </section>
    </div>
    <footer th:replace="~{admin/fragments/_footer :: footer}"></footer>
</div>
<div th:replace="~{admin/fragments/_footer :: common_scripts}"></div>

<script th:inline="javascript">
    $(document).ready(function() {

        /* Logic cho dropdown pin mới (lấy ra từ trạm)*/

        // Dữ liệu pin available
        var availableBatteries = [
            /*[# th:each="bat : ${availableBatteries}"]*/
            {
                id: [[${bat.id}]],
                name: "[(${bat.serialNumber})] - [(${bat.currentChargePercentage})]%",
                stationId: [[${bat.station?.id}]]
            },
            /*[/]*/
        ];

        var $batteryOutSelect = $('#batteryOut');
        var $stationSelect = $('#station');

        function updateBatteryOutDropdown(stationId) {
            // Luôn xóa sạch và thêm lại placeholder
            $batteryOutSelect.empty().append('<option value="">-- Chọn pin mới --</option>');

            if (!stationId) {
                $batteryOutSelect.prop('disabled', true);
                // Đặt lại text của placeholder
                $batteryOutSelect.find('option[value=""]').text('-- Vui lòng chọn trạm trước --');
                return;
            }

            var filtered = availableBatteries.filter(b => b.stationId == stationId);

            if (filtered.length > 0) {
                $batteryOutSelect.prop('disabled', false);
                filtered.forEach(b => $batteryOutSelect.append(new Option(b.name, b.id)));
            } else {
                $batteryOutSelect.prop('disabled', true);
                // Thêm một option "disabled" *sau* placeholder
                $batteryOutSelect.append('<option value="" disabled>Không có pin sẵn sàng tại trạm này</option>');
            }
        }

        $stationSelect.change(function() {
            updateBatteryOutDropdown($(this).val());
        });

        // Khởi chạy ban đầu cho "Pin Mới"
        var currentStationId = $stationSelect.val();
        var selectedOutId = [[${transaction.batteryOut?.id}]];

        if (currentStationId) {
            updateBatteryOutDropdown(currentStationId);
            if (selectedOutId) $batteryOutSelect.val(selectedOutId);
        } else {
            updateBatteryOutDropdown(null); // Vô hiệu hóa lúc đầu
        }

        /* logic cho dropdown pin khách trả vào                  */

        var $userSelect = $('#user');
        var $batteryInSelect = $('#batteryIn');

        // 1. Lưu lại tất cả các tùy chọn pin rented
        var $allBatteryInOptions = $batteryInSelect.find('option[data-user-id]').clone();

        // 2. Xóa các tùy chọn pin khỏi DOM, *chỉ để lại placeholder*
        $batteryInSelect.find('option[data-user-id]').remove();

        function updateBatteryInForUser(selectedUserId) {
            var currentBatteryInValue = $batteryInSelect.val();

            // 3. Xóa các tùy chọn pin (data-user-id) và thông báo (disabled) cũ
            $batteryInSelect.find('option[data-user-id]').remove();
            $batteryInSelect.find('option[disabled]').remove();

            // 4. Lấy placeholder CÓ SẴN
            var $placeholder = $batteryInSelect.find('option[value=""]');

            if (!selectedUserId) {
                $placeholder.text('-- Vui lòng chọn khách hàng trước --');
                $batteryInSelect.prop('disabled', true);
                return;
            }

            $batteryInSelect.prop('disabled', false);
            $placeholder.text('-- Chọn pin khách trả --');

            var found = false;
            $allBatteryInOptions.each(function() {
                if ($(this).data('user-id') == selectedUserId) {
                    $batteryInSelect.append($(this).clone());
                    found = true;
                }
            });

            if (!found) {
                $batteryInSelect.append('<option value="" disabled>Khách hàng này không có pin nào đang thuê</option>');
            }

            // Chọn lại giá trị cũ (nếu là form Edit)
            if(currentBatteryInValue) {
                $batteryInSelect.val(currentBatteryInValue);
            }
        }

        $userSelect.on('change', function() {
            // Khi đổi user, reset giá trị pin cũ về "chưa chọn"
            $batteryInSelect.val("");
            updateBatteryInForUser($(this).val());
        });

        // 5. Chạy lần đầu khi tải trang (quan trọng cho form Sửa)
        var initialUserId = $userSelect.val();
        updateBatteryInForUser(initialUserId);
    });
</script>


</body>
</html>